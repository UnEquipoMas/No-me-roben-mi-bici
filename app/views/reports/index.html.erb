<h1>Reportes</h1>

<div class = "row">
  <div class="col-sm-4">
    <table border = "1">
      <thead>
        <tr>
          <th>Tipo de reporte</th>
          <th>Sitio</th>
          <th>Fecha</th>
          <th>Hora</th>
          <th>Fecha de publicaci√≥n</th>
        </tr>
      </thead>
    
      <tbody>
        <% @report.each do |rep| %>
          <tr>
            <h4><td><%= rep.type_report.description %></td></h4>
            <td><%= rep.site.name %></td>
            <td><%= rep.date %></td>
            <td><%= rep.hour%></td>
            <td><%= rep.created_at %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <%= will_paginate @report %>
  </div>
   
   <div class="col-sm-8">
      <div>
        <div id="map" style='width: 800px; height: 600px;'></div>
      </div>
   </div>
</div>


<script type="text/javascript">
  var markers = [];

  handler = Gmaps.build('Google');
  handler.buildMap({ provider: {
    zoom: 10,
      center: new google.maps.LatLng(4.635540,-74.082807),
  }, internal: {id: 'map'}}, function(){
  markers = handler.addMarkers(<%=raw @hash.to_json %>);
    handler.bounds.extendWith(markers);
    handler.fitMapToBounds();
  });
  
  google.maps.event.addListener(handler.getMap(), 'click', function(event) {
    placeMarker(event.latLng);
    dir(event.latLng);
  })
  
  function dir (latlng){
    var geocoder = new google.maps.Geocoder();
    var infowindow = new google.maps.InfoWindow;
    geocoder.geocode({'location': latlng}, function(results, status) {
      if (status === 'OK') {
        if (results[1]) {
          //handler.getMap().setZoom(11);
          var marker = new google.maps.Marker({
            position: latlng,
            map: handler.getMap()
          });
          document.getElementById("report_site_name").value = results[1].formatted_address;
          console.log(results)
          infowindow.setContent(results[1].formatted_address);
          infowindow.open(map, marker);
        } else {
          window.alert('No results found');
        }
      } else {
        window.alert('Geocoder failed due to: ' + status);
      }
    });

  }
  
  function placeMarker(location) {
    var marker = new google.maps.Marker({
        position: location, 
        map: handler.getMap(),
        draggable: true
    });
    document.getElementById('report_site_lat').value = location;
    var aux = document.getElementById('report_site_lat').value.substr(1,document.getElementById('report_site_lat').value.length - 2).split(",")
    document.getElementById("report_site_lat").value = aux[0]
    document.getElementById("report_site_long").value = aux[1]
    //document.getElementById("site_latitude").value = aux[0]
    //document.getElementById("site_longitude").value = aux[1]

    google.maps.event.addListener(marker, 'click', function(event) {
      marker.setMap(null);
    });
  }
    
</script>

